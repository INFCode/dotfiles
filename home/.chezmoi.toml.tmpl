{{/* Custom config */}}

{{- $hosttype := promptChoiceOnce . "hosttype" "Which type of host is this" (list "work" "personal") "work" -}}
{{- $fancy := promptChoiceOnce . "fancy" "Enable fancy features" (list "all" "basic" "none") "none" -}}
{{- $headless := promptBoolOnce . "headless" "Is this device headless" true -}}

{{/* Define all variables to make template happy */}}

{{- $editor := "neovim" -}}
{{- $editor_bin := "nvim" -}}{{/* name of editor binary */}}
{{- $nvim_config := "custom" -}}
{{- $username := "INFCode" -}}
{{- $email := "INFCode@163.com" -}}

{{/* Infer detailed config */}}

{{- if eq $fancy "all" -}}
{{-   $nvim_config = "lazyvim" -}}
{{- else if eq $fancy "basic" -}}
{{/*  Nothing to do for now */}}
{{- else if eq $fancy "none" -}}
{{-   $editor = "vim" -}}
{{-   $editor_bin = "vim" -}}
{{- else -}}
{{-   printf "Unknown fancy level (%v)!" $fancy | fail -}}
{{- end -}}

{{- if eq $hosttype "personal" -}}
{{/*  Nothing to do for now */}}
{{- else if eq $hosttype "work" -}}
{{-   $username = promptStringOnce . "username" "User name" -}}
{{-   $email = promptStringOnce . "email" "Email" -}}
{{- else -}}
{{-   printf "Unknown hosttype (%v)!" $hosttype | fail -}}
{{- end -}}

{{- if $headless -}}
{{/*  Nothing to do for now */}}
{{- else -}}
{{/*  Nothing to do for now */}}
{{- end -}}

{{- $distroData := joinPath .chezmoi.workingTree "data/distro.toml" | include | fromToml -}}
{{- $osid := .chezmoi.os -}}
{{- $distro := .chezmoi.os -}}
{{- if hasKey .chezmoi.osRelease "id" -}}
{{-   $distro = .chezmoi.osRelease.id -}}
{{-   $osid = printf "%s-%s" .chezmoi.os .chezmoi.osRelease.id -}}
{{- end -}}

{{- $family := "unknown" -}}
{{- $package_manager := "unknown" -}}
{{- if hasKey $distroData.distros $distro -}}
{{-   $dConfig := index $distroData.distros $distro -}}
{{-   $family = $dConfig.family -}}
{{-   if hasKey $dConfig "package_manager" -}}
{{-     $package_manager = index $dConfig "package_manager" -}}
{{-   end -}}
{{- end -}}
{{- if eq $package_manager "unknown" -}}
{{-   if hasKey $distroData.families $family -}}
{{-     $package_manager = (index $distroData.families $family).package_manager -}}
{{-   end -}}
{{- end -}}

{{- if eq $family "unknown" -}}
{{-   printf "No matching family for osid %v" $osid | fail -}}
{{- end -}}

{{- if eq $package_manager "unknown" -}}
{{-   printf "No matching package manager for osid %v" $osid | fail -}}
{{- end -}}

[data]
    hosttype = {{ $hosttype | quote }}
    fancy = {{ $fancy | quote }}
    headless = {{ $headless }}
    email = {{ $email | quote }}
    username = {{ $username | quote }}
    editor = {{ $editor | quote }}
    editor_bin = {{ $editor_bin | quote }}
    nvim_config = {{ $nvim_config | quote }}
    distro = {{ $distro | quote }}
    family = {{ $family | quote }}
    package_manager = {{ $package_manager | quote }}